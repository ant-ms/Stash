app-id: ms.ant.stash.tv-client
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: zypak-wrapper.sh
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=system-bus
  - --socket=session-bus
  - --socket=pulseaudio
  - --device=dri
  - --share=network
  - --filesystem=xdg-config/stash:create
  - --filesystem=xdg-cache/stash:create
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons
modules:
  - name: zypak
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/refi64/zypak
        tag: v2025.09
    build-commands:
      - make
      - install -Dm755 build/zypak-sandbox /app/bin/zypak-sandbox
      - install -Dm755 build/zypak-helper /app/bin/zypak-helper
      - install -d /app/lib/zypak
      - install -Dm755 build/libzypak-preload-host.so /app/lib/zypak/libzypak-preload-host.so
      - install -Dm755 build/libzypak-preload-child.so /app/lib/zypak/libzypak-preload-child.so
      - |
        cat > zypak-wrapper <<EOF
        #!/bin/bash
        export ZYPAK_BIN=/app/bin/zypak-sandbox
        export ZYPAK_SANDBOX_FILENAME=/app/bin/zypak-sandbox
        export ZYPAK_LIB_DIR=/app/lib/zypak
        export LD_PRELOAD=\$ZYPAK_LIB_DIR/libzypak-preload-host.so
        exec "\$@"
        EOF
      - install -Dm755 zypak-wrapper /app/bin/zypak-wrapper

  - name: tv-client
    buildsystem: simple
    build-commands:
      - install -d /app/bin
      - cp -a . /app/bin/
      - rm -f /app/bin/chrome-sandbox
      - install -Dm755 zypak-wrapper.sh /app/bin/zypak-wrapper.sh
    sources:
      - type: dir
        path: dist/linux-unpacked
      - type: file
        path: zypak-wrapper.sh
